---
title: Add vregâ†’preg rewriting for Priority 4-6 advanced instructions
status: closed
priority: 2
issue-type: task
created-at: "2026-01-07T11:05:38.850588+02:00"
closed-at: "2026-01-07T11:14:35.612288+02:00"
---

File: src/codegen/compile.zig in emitAArch64WithAllocation()

Phase 2: Advanced arithmetic, shifts, and conditionals (~52 instruction types)

Priority 4 - Advanced Arithmetic (15 types):
- Multiply-add: madd, msub, smulh, umulh, smull, umull
- Add/sub with flags: adds_rr, adds_imm, subs_rr, subs_imm
- Add/sub with carry: adcs, sbcs
- Shifted operations: add_shifted, sub_shifted, add_extended, sub_extended

Priority 5 - Shifts & Bit Manipulation (17 types):
- Logical shifts: lsl_rr, lsl_imm, lsr_rr, lsr_imm, asr_rr, asr_imm
- Rotate: ror_rr, ror_imm
- Bitwise: bic_rr, orn_rr, eon_rr, mvn_rr
- Arithmetic: neg, clz, cls, ctz, rbit

Priority 6 - Conditional & Special (10 types):
- Conditional select: csel, cset, cinc
- Address: adr, adrp, adrp_symbol, add_symbol_lo12, lea
- Test: tst_imm
- Extended: sub_extended

Pattern (3-operand): dst, src1, src2
Pattern (2-operand): dst, src
Pattern (1-operand): dst only

All follow same systematic rewriting as Priorities 1-3.
Estimated: 300-400 LOC
