---
title: Fix allocator corruption in e2e_jit test cleanup
status: closed
priority: 2
issue-type: task
created-at: "\"2026-01-08T06:08:00.683519+02:00\""
closed-at: "2026-01-08T06:11:23.059963+02:00"
---

File: tests/e2e_jit.zig - Test 'compile and execute return constant i32' crashes with allocator corruption during cleanup. 

EVIDENCE:
- JIT code executes CORRECTLY and returns 42 ✓
- Machine code is PERFECT (20 bytes, proper prologue/epilogue/ret) ✓
- Crash happens during defer cleanup, specifically during std.debug.print('Freeing executable memory...')
- Stack trace shows ___gtxf2 (soft-float comparison) which is suspicious
- Crash is 'reached unreachable code' in debug_allocator.zig:806 (log2PtrAligns)
- This is a RECURSIVE PANIC - original panic happens, then panic handling triggers another panic

RULED OUT:
- Use-after-free in test code (FIXED - was shallow copy issue)
- Stack corruption from JIT code (JIT returns correctly)
- Callee-save register clobbering (generated code only touches X29, X30, W0)

LIKELY CAUSES:
1. Memory corruption during compilation pipeline (MachBuffer, ArrayList management)
2. Heap metadata corruption from earlier code
3. Buffer overflow in code generation
4. Issue with CompiledCode ownership/deinit

NEXT STEPS:
1. Test with GeneralPurposeAllocator instead of testing.allocator to get better diagnostics
2. Run with Valgrind/AddressSanitizer to detect memory corruption
3. Add memory tracking in MachBuffer and CompiledCode
4. Check if issue reproduces without debug prints
5. Investigate why allocator needs to do FP comparisons (___gtxf2)
