---
title: Add vregâ†’preg rewriting for remaining critical instruction types
status: closed
priority: 2
issue-type: task
created-at: "2026-01-07T10:46:09.557060+02:00"
closed-at: "2026-01-07T11:02:10.146218+02:00"
---

File: src/codegen/compile.zig in emitAArch64WithAllocation()

Currently handled: mov_imm, add_rr, mov_rr, mul_rr, movz, movk, cmp_rr, ret

Need to add rewriting for instructions that are commonly generated:
- Arithmetic: sub_rr, sub_imm, add_imm (for stack operations)
- Loads/stores: ldr, str, ldp, stp (for stack frames and memory access)
- Branches: br, b_cond, cbz, cbnz (for control flow)
- Shifts: lsl_rr, lsr_rr, asr_rr (common in lowering)
- Bitwise: and_rr, orr_rr, eor_rr (common operations)

Strategy: Add rewriting cases as tests fail with 'FATAL: Virtual register' panics. This is more efficient than adding all ~100+ instruction types upfront.

Priority: Medium - needed to unblock more complex tests
